<template>
  <div id="cve-secondary-page-main-container">
    <div class="columns is-centered">
      <div class="column is-8-desktop cve-main-column-content-width">
        <main id="cve-main-page-content" role="main">
          <div class="content">
          <button class="button" @click="showFakeData">Show fake data</button>
          <div class="loader-wrapper is-active" v-if="this.$store.state.isSearching">
            <p class="is-size-5">Please wait. Loading...</p>
            <p class="loader is-loading mb-4 ml-1"></p>
          </div>
          <div v-else>
            <div v-if="this.$store.state.serverError" style="text-align: center;">
              <h1 class="title is-4">Service is currently unavailable.</h1>
              <p style="text-align: center;">Please
                <span class="icon-text">
                  <a href="https://cveform.mitre.org/" target="_blank">report the issue
                    <span class="icon is-size-7 cve-icon-xxs">
                      <p id="extenalLink1" class="is-hidden">external site</p>
                      <font-awesome-icon icon="external-link-alt" aria-labelledby="extenalLink1" aria-hidden="false" focusable="false"/>
                    </span>
                  </a>
                </span>
                and try again later. Sorry for the inconvenience.
              </p>
            </div>
            <p v-if="this.$store.state.showHelpText" style="text-align: center;">
              Please use the search box above to find a CVE record by ID.
            </p>
            <div v-if="!this.$store.state.isSearching && !this.$store.state.showHelpText && !this.$store.state.serverError">
              <div v-if="this.$store.state.error" style="text-align: center !important">
                <h1 class="title is-3 is-4 mb-2">{{this.$store.state.cveId}} not found.</h1>
                <span class="icon-text">
                  <a href="https://cve.mitre.org/cve/search_cve_list.html" target="_blank">
                  Find CVE Record by Keyword
                  <span class="icon cve-icon-xxs" style="margin-left: 0px;">
                    <p id="CVERecordsKeywordSearch" class="is-hidden">external site</p>
                    <font-awesome-icon icon="external-link-alt" aria-labelledby="CVERecordsKeywordSearch">
                    </font-awesome-icon>
                  </span>
                  </a>
                </span>
              </div>
              <div v-else>
                <nav class="level">
                  <div class="level-left">
                    <h1 class="level-item title is-3 is-3">{{this.$store.state.recordData.cveMetadata.cveId}} Detail</h1>
                    <div class="buttons is-right" @click="showJsonModal=true">
                      <button id="cve-json-modal-button" class="button modal-button cve-button-ghost"
                        data-target="#json-modal" aria-haspopup="true">
                        View Full JSON 5.0 Record
                      </button>
                    </div>
                  </div>
                  <div class="level-right">
                    <div v-if="showJsonModal" class="level-item modal is-active">
                      <div class="modal-background"></div>              
                      <div class="modal-content">
                        <div class="message-body">                
                          <pre>{{JSON.stringify(this.$store.state.recordData, null, 2)}}</pre>
                        </div>
                      </div>
                      <button class="modal-close is-large" aria-label="close" @click="showJsonModal=false"></button>
                    </div>
                  </div>
                </nav>
                <p class="cve-help-text">The CVE Record information displayed on this page may not be displaying the full range of available
                  information due to differences in how the data may have been entered. If you feel that the information being displayed is not
                  meeting your expectations, please let us know by using this
                  <a href="https://tinyurl.com/cve-record-detail-survey" target="_blank">feedback form
                    <span class="icon cve-icon-xxs">
                      <p id="externalLinkRecordFeedbackForm" class="is-hidden">external website</p>
                      <font-awesome-icon icon="external-link-alt" aria-labelledby="externalLinkRecordFeedbackForm"/>
                    </span>
                  </a>
                </p>
                <div id="cve-record-container">
                  <div v-for="row in cveFieldList" class="columns cve-record-row">                 
                    <div class="column is-one-quarter cve-record-row-label">
                      {{row.rowLabel}}
                    </div>
                    <ExpandableHTML :data="row" />
                  </div>
                </div>                  
                <div>
                  <span>View additional information about 
                    <a :href="NVDUrl" target='_blank'>
                      {{this.$store.state.recordData.cveMetadata.cveId}}
                      <span class='icon cve-icon-xxs'>
                        <p id='nvd' class='is-hidden'>external site</p>
                          <font-awesome-icon icon='external-link-alt' aria-labelledby='nvd'>
                          </font-awesome-icon>
                      </span>
                    </a>
                    on NVD.
                  </span>
                  <p class='cve-help-text'>(Note: The NVD is not operated by the CVE Program)</p>
                </div>
              </div>
            </div>
          </div>
          </div>
        </main>
      </div>
    </div>
  </div>
</template>

<script>
import basicExample from '@/assets/data/tmpBasic5Example.json';
import advancedExample from '@/assets/data/tmpAdvanced5Example.json';
import cveRecordFields from '@/assets/data/cveRecordFields.json';
import ExpandableHTML from '@/components/ExpandableHTML.vue';

export default {
  name:'CVERecord5',
  components: {
    ExpandableHTML,
  },
  data() {
    return {
      showJsonModal: false,
      cveRecordRows: cveRecordFields.cveRecordRows,
      contentClasses: "column is-three-quarters cve-record-row-content",
    }
  },
  computed: {
    cveFieldList() {
      var fieldsWithData = [];
      this.cveRecordRows.forEach((row, index) => {
        var rowData = this.getContentForRow(row);
        if (rowData) {
          rowData.classes = index % 2 == 0 ? this.contentClasses : this.contentClasses + " row-stripe";
          fieldsWithData.push(rowData);
        }
      });
      return fieldsWithData;
    },
    NVDUrl() {
      return "https://nvd.nist.gov/view/vuln/detail?vulnId=" + this.$store.state.recordData.cveMetadata.cveId;
    } 
  },
  methods: {
    // SRL - remove showFakeData when JSON 5.0 service is ready
    showFakeData() {
      this.$store.commit('updateState', { showHelpText: false, isSearching: false, serverError: false });    
      this.$store.state.recordData = advancedExample;
    },
    getCNA(recordData) {
      return (recordData.cveMetadata.assignerShortName) ? recordData.cveMetadata.assignerShortName : "";
    },
    getDescription(recordData) {
      var content = [];
      if (recordData.containers.cna.descriptions.length > 0) {
        recordData.containers.cna.descriptions.forEach((desc) => {
          content.push(desc.value);
        });
      }
      return content;
    },
    getProblemType(recordData) {
      var content = ["test", "test2", "test3", "test4", "test5"];
      if (recordData.containers.cna.problemTypes.length > 0) {
        recordData.containers.cna.problemTypes.forEach((type) => {
          type.descriptions.forEach((desc) => {
            content.push(desc.description);
          });
        });
      }
      return {"content":content, "classes":'tag is-rounded has-text-grey-dark is-capitalized'};  
    },
    getReferences(recordData) {
      var content = [];
      var thisItem = {};
      thisItem.classes = 'cve-task-tile-list-item';
      recordData.containers.cna.references.forEach((ref) => {
        if (ref.url != undefined) {
          thisItem.content = "<a :href='" + ref.url +"' class='cve-word-wrap' target='_blank'>"
                            + ref.url
                            + "</a>"; 
          content.push(thisItem);
        }
      });
      return content;
    },
    getState(recordData) {
      return (recordData.cveMetadata.state) ? recordData.cveMetadata.state : "";
    },
    // SRL - need to add; don't know where to find these yet
    getTags(recordData) {
      var content = [];
      return {"content":content, "classes":'tag is-rounded has-text-grey-dark is-capitalized'};  
    },
    getAffectedVersions(versions) {
      var content = "";
      versions.forEach((version) => {
        if (version.status == 'affected') {
          content += "<li class='ml-5'>";
          content += "Still working out what goes here";
          content += "</li>";
        }
      });
      if (content.length > 0) {
        content = "<ul>" + content + "</ul>";
      }
      return content;
    },
    getVendorsProductsVersions(recordData) {
      var content = [];
      var thisItem = {};
      var contentStr = "";
      thisItem.classes = "cve-list-no-bullet";
      recordData.containers.cna.affected.forEach((entry) => {
        contentStr = "<span class='has-text-weight-bold'>Vendor: </span>";
        contentStr += (entry.vendor == 'n/a') ? "<span class='is-italic'>Not Specified</span>":"<span>" + entry.vendor + "</span>";

        contentStr +=  "<ul class='mb-2'>";
        contentStr += (entry.product != undefined) ? "<li class='cve-list-no-bullet'><span class='has-text-weight-bold'>Product: </span><span>" + entry.product + "</span></li>":"";
        var affectedVersions = this.getAffectedVersions(entry.versions);
        contentStr += (affectedVersions.length > 0) ? "<li class='cve-list-no-bullet'><span class='has-text-weight-bold'>Versions Affected: </span>"
                    + affectedVersions + "</li>": "";
        thisItem.content = contentStr;
        content.push(thisItem);
      });
      return content;
    },
    getContentForRow(row) {
      var rowData = row;
      var additionalRowData = {};
      var recordData = this.$store.state.recordData;
      switch(row.rowLabel) {
        case "CNA":
          rowData.content = this.getCNA(recordData);
          break;
        case "Description":
          rowData.content = this.getDescription(recordData);
          break;
        case "Problem Type":
          additionalRowData = this.getProblemType(recordData);
          rowData.content = additionalRowData.content;
          rowData.itemClasses = additionalRowData.classes;
          break;
        case "References":
          rowData.content = this.getReferences(recordData);
          break;
        case "State":
          rowData.content = this.getState(recordData);
          break;
        case "Tags":
          additionalRowData = this.getTags(recordData);
          rowData.content = additionalRowData.content;
          rowData.itemClasses = additionalRowData.classes;
          break;
        case "Vendors, Products & Versions":
          rowData.content = this.getVendorsProductsVersions(recordData);
          break;
        default:
          rowData = undefined;
      }
      return rowData;
    },
    toggleRecord() {
      this.$store.commit('updateState', { showJsonRecord: !this.$store.state.showJsonRecord });
    },
  },
};

</script>

<style scoped lang="scss">
@import '@/assets/style/globals.scss';

#cve-json-modal-button {
  color: $theme-color-primary !important;
  font-weight: bold;
}

.cve-record-row {
  margin: 0px !important;
}

.cve-record-row-label {
  color: white;
  background-color: $theme-color-primary-darker;
  border: 1px solid white !important;  
}

.cve-record-row-content {
  border: 1px solid $theme-color-primary-darker;
  padding: .75em;
}

.row-stripe {
  background-color: $theme-color-base-lightest;
}

pre {
  outline: 1px solid $theme-color-primary-darker; padding: 5px; margin: 5px;
  white-space: pre-wrap !important;
}

.cve-word-wrap {
  overflow-wrap: break-word;
  word-wrap: break-word;
  -ms-word-break: break-all;
  word-break: break-all;
  word-break: break-word;
  -ms-hyphens: auto;
  -moz-hyphens: auto;
  -webkit-hyphens: auto;
  hyphens: auto;
}

.loader-wrapper {
  background: #fff;
  opacity: 0;
  z-index: -1;
  transition: opacity .3s;
  display: flex;
  justify-content: center;
  align-items: center;

  &.is-active {
      opacity: 1;
      z-index: 1;
  }
}

</style>
