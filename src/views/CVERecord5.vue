<template>
  <div id="cve-secondary-page-main-container">
    <div class="columns is-centered">
      <div class="column is-8-desktop cve-main-column-content-width">
        <main id="cve-main-page-content" role="main">
          <div class="content">
          <button class="button" @click="showFakeData">Show fake data</button>
          <div class="loader-wrapper is-active" v-if="this.$store.state.isSearching">
            <p class="is-size-5">Please wait. Loading...</p>
            <p class="loader is-loading mb-4 ml-1"></p>
          </div>
          <div v-else>
            <div v-if="this.$store.state.serverError" style="text-align: center;">
              <h1 class="title is-4">Service is currently unavailable.</h1>
              <p style="text-align: center;">Please
                <span class="icon-text">
                  <a href="https://cveform.mitre.org/" target="_blank">report the issue
                    <span class="icon is-size-7 cve-icon-xxs">
                      <p id="extenalLink1" class="is-hidden">external site</p>
                      <font-awesome-icon icon="external-link-alt" aria-labelledby="extenalLink1" aria-hidden="false" focusable="false"/>
                    </span>
                  </a>
                </span>
                and try again later. Sorry for the inconvenience.
              </p>
            </div>
            <p v-if="this.$store.state.showHelpText" style="text-align: center;">
	      Please use the search box above to find a CVE record by ID.
	    </p>
            <div v-if="!this.$store.state.isSearching && !this.$store.state.showHelpText && !this.$store.state.serverError">
              <div v-if="this.$store.state.error" style="text-align: center !important">
                <h1 class="title is-3 is-4 mb-2">{{this.$store.state.cveId}} not found.</h1>
                <span class="icon-text">
                  <a href="https://cve.mitre.org/cve/search_cve_list.html" target="_blank">
                  Find CVE Record by Keyword
                  <span class="icon cve-icon-xxs" style="margin-left: 0px;">
                    <p id="CVERecordsKeywordSearch" class="is-hidden">external site</p>
                    <font-awesome-icon icon="external-link-alt" aria-labelledby="CVERecordsKeywordSearch">
                    </font-awesome-icon>
                  </span>
                  </a>
                </span>
              </div>
              <div v-else>
                <h1 class="title is-3 is-3">{{this.$store.state.recordData.cveMetadata.cveId}} Detail</h1>
		<div class="buttons is-right" @click="showJsonModal=true">
  		  <button id="cve-json-modal-button" class="button modal-button cve-button-ghost"
		    data-target="#json-modal" aria-haspopup="true">
		    View Full JSON 5.0 Record
		  </button>
		</div>
                <div v-if="showJsonModal" class="modal is-active">
                  <div class="modal-background"></div>		
	          <div class="modal-content">
                    <div class="message-body">		  
		      <pre>{{JSON.stringify(this.$store.state.recordData, null, 2)}}</pre>
		    </div>
		  </div>
  		  <button class="modal-close is-large" aria-label="close" @click="showJsonModal=false"></button>
		</div>
                <p class="cve-help-text">The CVE Record information displayed on this page may not be displaying the full range of available
                  information due to differences in how the data may have been entered. If you feel that the information being displayed is not
                  meeting your expectations, please let us know by using this
                  <a href="https://tinyurl.com/cve-record-detail-survey" target="_blank">feedback form
                    <span class="icon cve-icon-xxs">
                      <p id="externalLinkRecordFeedbackForm" class="is-hidden">external website</p>
                      <font-awesome-icon icon="external-link-alt" aria-labelledby="externalLinkRecordFeedbackForm"/>
                    </span>
                  </a>
                </p>
		<div id="cve-record-container">
		  <div v-for="row in cveFieldList" :key="index" class="columns cve-record-row">
		      <div class="column is-one-quarter cve-record-row-label">
		        {{row.rowLabel}}
		      </div>
		      <div v-if="row.content" class="column is-three-quarters cve-record-row-content">
		        {{row.content}}
		      </div>
		      <div v-else class="column is-three-quarters cve-record-row-content">
		        SRL - replace contenttype {{row.contentType}} with actual data
		      </div>
		  </div>
		</div>
              </div>
            </div>
          </div>
          </div>
        </main>
      </div>
    </div>
  </div>
</template>

<script>
import basicExample from '@/assets/data/tmpBasic5Example.json';
import advancedExample from '@/assets/data/tmpAdvanced5Example.json';
import cveRecordFields from '@/assets/data/cveRecordFields.json';

export default {
  name:'CVERecord5',
  data() {
    return {
      showJsonModal: false,
      cveRecordRows: cveRecordFields.cveRecordRows,
    }
  },
  computed: {
    cveFieldList() {
      var fieldsWithData = [];
      this.cveRecordRows.forEach((row) => {
        var rowData = this.getContentForRow(row);
        if (rowData) {
	  fieldsWithData.push(rowData);
	}
      });
      return fieldsWithData;
    }
  },
  methods: {
    // SRL - showFakeData when JSON 5.0 service is ready
    showFakeData() {
      this.$store.commit('updateState', { showHelpText: false, isSearching: false, serverError: false });    
      this.$store.state.recordData = advancedExample;
    },
    getContentForRow(row) {
      var rowData = undefined;
      var recordData = this.$store.state.recordData;
      switch(row.rowLabel) {
        case "CNA":
	  if (recordData.cveMetadata.assignerShortName) {
	    rowData = row;
	    rowData.content = recordData.cveMetadata.assignerShortName;
	  }
	  break;
	case "Description":
	  if (recordData.containers.cna.descriptions.length > 0) {
	    rowData = row;
	  }
	  break;
	case "Tags":
	  // SRL - need to add; don't know where to find these yet
	  break;
	case "State":
	  if (recordData.cveMetadata.state) {
	    rowData = row;
	    rowData.content = recordData.cveMetadata.state;
          }
	  break;
	case "Problem Type":
	  if (recordData.containers.cna.problemTypes.length > 0) {
	    rowData = row;
	  }
	  break;
	case "Vendors, Products & Versions":
	  if (recordData.containers.cna.affected.length > 0) {
	    rowData = row;
	  }
	  break;
	case "References":
	  if (recordData.containers.cna.references.length > 0) {
	    rowData = row;
	  }
	default:
	  rowData = undefined;
      }
      return rowData;
    },
    toggleRecord() {
      this.$store.commit('updateState', { showJsonRecord: !this.$store.state.showJsonRecord });
    },
  },
};

</script>

<style scoped lang="scss">
@import '@/assets/style/globals.scss';

#cve-json-modal-button {
  color: $theme-color-primary !important;
  font-weight: bold;
}

.cve-record-row {
  border: 1px solid $theme-color-primary-darker;
}

.cve-record-row-label {
  color: white;
  background-color: $theme-color-primary-darker;
  border: 1px solid white !important;  
}

.cve-record-row-content {
}

pre {
  outline: 1px solid $theme-color-primary-darker; padding: 5px; margin: 5px;
}

.cve-word-wrap {
  overflow-wrap: break-word;
  word-wrap: break-word;
  -ms-word-break: break-all;
  word-break: break-all;
  word-break: break-word;
  -ms-hyphens: auto;
  -moz-hyphens: auto;
  -webkit-hyphens: auto;
  hyphens: auto;
}

tr:first-child th {
  border-top-color: $theme-color-primary-darker !important;
}

tr:last-child th {
  border-bottom-color: $theme-color-primary-darker !important;
}

.loader-wrapper {
  background: #fff;
  opacity: 0;
  z-index: -1;
  transition: opacity .3s;
  display: flex;
  justify-content: center;
  align-items: center;

  &.is-active {
      opacity: 1;
      z-index: 1;
  }
}

pre {
  white-space: pre-wrap !important;
}
</style>
